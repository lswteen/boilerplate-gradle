package com.farfarcoder.cve.controller;

import com.farfarcoder.cve.domain.ScanProject;
import com.farfarcoder.cve.service.CveImportService;
import com.farfarcoder.cve.service.ProjectScanService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/cve")
@RequiredArgsConstructor
@Tag(name = "CVE Dashboard", description = "CVE Scanning and Management API")
public class CveController {

    private final CveImportService cveImportService;
    private final ProjectScanService projectScanService;

    @PostMapping("/import")
    @Operation(summary = "Import CVEs", description = "Import CVE JSON files from a local directory for a given year range.")
    public ResponseEntity<String> importCves(
            @RequestParam String folderPath,
            @RequestParam int startYear,
            @RequestParam int endYear) {
        int count = cveImportService.importCveFromFolder(folderPath, startYear, endYear);
        return ResponseEntity.ok("Imported " + count + " CVE items.");
    }

    @PostMapping("/scan")
    @Operation(summary = "Scan Project", description = "Scan a local project (Gradle/Maven) for vulnerabilities.")
    public ResponseEntity<ScanProject> scanProject(@RequestParam String projectPath) {
        ScanProject result = projectScanService.scanProject(projectPath);
        return ResponseEntity.ok(result);
    }
}
