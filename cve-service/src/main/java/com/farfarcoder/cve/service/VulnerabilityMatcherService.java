package com.farfarcoder.cve.service;

import com.farfarcoder.cve.domain.CveAffectedProduct;
import com.farfarcoder.cve.domain.CveItem;
import com.farfarcoder.cve.domain.Vulnerability;
import com.farfarcoder.cve.repository.CveAffectedProductRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class VulnerabilityMatcherService {

    private final CveAffectedProductRepository cveAffectedProductRepository;
    private final VersionMatcher versionMatcher;

    public List<Vulnerability> findVulnerabilities(String dependency) {
        // dependency format: group:artifact:version
        String[] parts = dependency.split(":");
        if (parts.length < 3)
            return List.of();

        // String group = parts[0];
        String artifact = parts[1];
        String version = parts[2];

        List<Vulnerability> results = new ArrayList<>();

        // 1. Find potential CVEs by artifact name (product name)
        log.info("Searching for vulnerabilities for artifact: {}", artifact);
        List<CveAffectedProduct> affectedProducts = cveAffectedProductRepository
                .findByProductContainingIgnoreCase(artifact);
        log.info("Found {} potential affected products for artifact {}", affectedProducts.size(), artifact);

        for (CveAffectedProduct product : affectedProducts) {
            // 2. Check version match
            if (versionMatcher.isVulnerable(version, product.getVersionsJson())) {
                CveItem cve = product.getCveItem();

                Vulnerability v = Vulnerability.builder()
                        .cveId(cve.getCveId())
                        .dependencyName(dependency)
                        .currentVersion(version)
                        .severity(cve.getCvssSeverity())
                        .description(cve.getDescription())
                        .build();
                results.add(v);
            }
        }

        return results;
    }
}
