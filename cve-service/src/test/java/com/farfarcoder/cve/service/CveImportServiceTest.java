package com.farfarcoder.cve.service;

import com.farfarcoder.cve.repository.CveItemRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.junit.jupiter.api.io.TempDir;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Spy;
import org.mockito.junit.jupiter.MockitoExtension;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.BDDMockito.given;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;

@ExtendWith(MockitoExtension.class)
class CveImportServiceTest {

    @Mock
    private CveItemRepository cveItemRepository;

    @Spy
    private ObjectMapper objectMapper = new ObjectMapper();

    @InjectMocks
    private CveImportService cveImportService;

    @Test
    @DisplayName("Should import CVEs from JSON files in year folders")
    void importCveFromFolder(@TempDir Path tempDir) throws IOException {
        // given
        Path yearDir = tempDir.resolve("2024");
        Files.createDirectory(yearDir);

        Path jsonFile = yearDir.resolve("CVE-2024-0001.json");
        String jsonContent = """
                {
                  "cve": {
                    "CVE_data_meta": { "ID": "CVE-2024-0001" },
                    "description": {
                      "description_data": [ { "value": "Test vulnerability" } ]
                    },
                    "affects": {
                      "vendor": {
                        "vendor_data": [
                          {
                            "product": {
                              "product_data": [ { "product_name": "test-product" } ]
                            }
                          }
                        ]
                      }
                    }
                  },
                  "impact": {
                    "baseMetricV3": {
                      "cvssV3": {
                        "baseScore": 7.5,
                        "baseSeverity": "HIGH"
                      }
                    }
                  }
                }
                """;
        Files.writeString(jsonFile, jsonContent);

        given(cveItemRepository.existsByCveId("CVE-2024-0001")).willReturn(false);

        // when
        int count = cveImportService.importCveFromFolder(tempDir.toString(), 2024, 2024);

        // then
        assertThat(count).isEqualTo(1);
        verify(cveItemRepository, times(1)).save(any());
    }
}
