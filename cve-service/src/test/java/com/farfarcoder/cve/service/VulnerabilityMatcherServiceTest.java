package com.farfarcoder.cve.service;

import com.farfarcoder.cve.domain.CveItem;
import com.farfarcoder.cve.domain.Vulnerability;
import com.farfarcoder.cve.repository.CveItemRepository;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.BDDMockito.given;

@ExtendWith(MockitoExtension.class)
class VulnerabilityMatcherServiceTest {

    @Mock
    private CveItemRepository cveItemRepository;

    @InjectMocks
    private VulnerabilityMatcherService vulnerabilityMatcherService;

    @Test
    @DisplayName("Should find vulnerabilities when product name matches artifact id")
    void findVulnerabilities() {
        // given
        String dependency = "org.springframework:spring-web:5.3.10";

        CveItem cveItem = CveItem.builder()
                .cveId("CVE-2021-1234")
                .productName("spring-web")
                .severity("HIGH")
                .description("Remote Code Execution")
                .build();

        given(cveItemRepository.findByProductNameContainingIgnoreCase("spring-web"))
                .willReturn(List.of(cveItem));

        // when
        List<Vulnerability> result = vulnerabilityMatcherService.findVulnerabilities(dependency);

        // then
        assertThat(result).hasSize(1);
        Vulnerability v = result.get(0);
        assertThat(v.getCveId()).isEqualTo("CVE-2021-1234");
        assertThat(v.getDependencyName()).isEqualTo(dependency);
        assertThat(v.getCurrentVersion()).isEqualTo("5.3.10");
        assertThat(v.getSeverity()).isEqualTo("HIGH");
    }

    @Test
    @DisplayName("Should return empty list when no cve matches")
    void findVulnerabilities_NoMatch() {
        // given
        String dependency = "com.example:safe-lib:1.0.0";

        given(cveItemRepository.findByProductNameContainingIgnoreCase("safe-lib"))
                .willReturn(List.of());

        // when
        List<Vulnerability> result = vulnerabilityMatcherService.findVulnerabilities(dependency);

        // then
        assertThat(result).isEmpty();
    }
}
