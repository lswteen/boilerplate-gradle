package com.farfarcoder.cve.service;

import com.farfarcoder.cve.domain.CveAffectedProduct;
import com.farfarcoder.cve.domain.CveItem;
import com.farfarcoder.cve.domain.Vulnerability;
import com.farfarcoder.cve.repository.CveAffectedProductRepository;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.BDDMockito.given;

@ExtendWith(MockitoExtension.class)
class VulnerabilityMatcherServiceTest {

    @Mock
    private CveAffectedProductRepository cveAffectedProductRepository;

    @Mock
    private VersionMatcher versionMatcher;

    @InjectMocks
    private VulnerabilityMatcherService vulnerabilityMatcherService;

    @Test
    @DisplayName("Should find vulnerabilities when product name matches artifact id and version is vulnerable")
    void findVulnerabilities() {
        // given
        String dependency = "org.springframework:spring-web:5.3.10";
        String artifact = "spring-web";
        String version = "5.3.10";
        String versionsJson = "[{\"version\": \"5.3.10\", \"status\": \"affected\"}]";

        CveItem cveItem = CveItem.builder()
                .cveId("CVE-2021-1234")
                .cvssSeverity("HIGH")
                .description("Remote Code Execution")
                .build();

        CveAffectedProduct product = CveAffectedProduct.builder()
                .product(artifact)
                .versionsJson(versionsJson)
                .cveItem(cveItem)
                .build();

        given(cveAffectedProductRepository.findByProductContainingIgnoreCase(artifact))
                .willReturn(List.of(product));

        given(versionMatcher.isVulnerable(version, versionsJson))
                .willReturn(true);

        // when
        List<Vulnerability> result = vulnerabilityMatcherService.findVulnerabilities(dependency);

        // then
        assertThat(result).hasSize(1);
        Vulnerability v = result.get(0);
        assertThat(v.getCveId()).isEqualTo("CVE-2021-1234");
        assertThat(v.getDependencyName()).isEqualTo(dependency);
        assertThat(v.getCurrentVersion()).isEqualTo("5.3.10");
        assertThat(v.getSeverity()).isEqualTo("HIGH");
    }

    @Test
    @DisplayName("Should return empty list when no cve matches")
    void findVulnerabilities_NoMatch() {
        // given
        String dependency = "com.example:safe-lib:1.0.0";
        String artifact = "safe-lib";

        given(cveAffectedProductRepository.findByProductContainingIgnoreCase(artifact))
                .willReturn(List.of());

        // when
        List<Vulnerability> result = vulnerabilityMatcherService.findVulnerabilities(dependency);

        // then
        assertThat(result).isEmpty();
    }
}
