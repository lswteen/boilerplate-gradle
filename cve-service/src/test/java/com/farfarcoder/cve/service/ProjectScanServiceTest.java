package com.farfarcoder.cve.service;

import com.farfarcoder.cve.domain.ScanProject;
import com.farfarcoder.cve.domain.Vulnerability;
import com.farfarcoder.cve.repository.ScanProjectRepository;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.junit.jupiter.api.io.TempDir;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.BDDMockito.given;

@ExtendWith(MockitoExtension.class)
class ProjectScanServiceTest {

    @Mock
    private ScanProjectRepository scanProjectRepository;

    @Mock
    private VulnerabilityMatcherService vulnerabilityMatcherService;

    @InjectMocks
    private ProjectScanService projectScanService;

    @Test
    @DisplayName("Should scan gradle project and extract dependencies")
    void scanProject_Gradle(@TempDir Path tempDir) throws IOException {
        // given
        Path buildGradle = tempDir.resolve("build.gradle");
        String content = """
                dependencies {
                    implementation 'org.springframework.boot:spring-boot-starter-web:3.0.0'
                    testImplementation "junit:junit:4.13.2"
                }
                """;
        Files.writeString(buildGradle, content);

        given(vulnerabilityMatcherService.findVulnerabilities(any()))
                .willReturn(List.of()); // Mock no vulnerabilities found for simplicity

        given(scanProjectRepository.save(any(ScanProject.class)))
                .willAnswer(invocation -> invocation.getArgument(0));

        // when
        ScanProject result = projectScanService.scanProject(tempDir.toString());

        // then
        assertThat(result.getProjectType()).isEqualTo("GRADLE");
        assertThat(result.getProjectPath()).isEqualTo(tempDir.toString());
        // We can't easily assert dependencies list size because it's local variable in
        // service,
        // but we can verify interaction or check if vulnerabilities were populated if
        // we mocked them.
        // In this simple test, we just check project type detection.
    }

    @Test
    @DisplayName("Should scan maven project")
    void scanProject_Maven(@TempDir Path tempDir) throws IOException {
        // given
        Path pomXml = tempDir.resolve("pom.xml");
        Files.writeString(pomXml, "<project>...</project>");

        given(scanProjectRepository.save(any(ScanProject.class)))
                .willAnswer(invocation -> invocation.getArgument(0));

        // when
        ScanProject result = projectScanService.scanProject(tempDir.toString());

        // then
        assertThat(result.getProjectType()).isEqualTo("MAVEN");
    }
}
